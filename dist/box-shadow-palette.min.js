/*!
 * box-shadow-palette v0.0.0 
 * (c) 2017 Dobromir Hristov
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.BoxShadowPalette=t()}(this,function(){"use strict";function e(){function e(e){var r=e;if(!e)throw Error("Target is not an element",e);return"IMG"!==e.tagName&&e.style.backgroundImage&&Error("Tag provided is not an image and does not have a background-image style attached to it."),"IMG"!==e.tagName&&(r=new Image(e.offsetWidth,e.offsetHeight),r.src=e.style.backgroundImage.replace("url(","").replace(")","").replace(/"/gi,"")),(new t).getPalette(r,3)}function r(e,t){return"rgba("+e[0]+", "+e[1]+", "+e[2]+", "+t+")"}function o(e,t){var o,n=i.options,a=n.opacity,u=n.opacitySecondary,c=n.boxShadowTemplate,s=e[i.options.colorIndexToUse],h=r(s,a),f=r(s,u);o=c?c.replace("{color}",h).replace("{colorSecondary}",f):"0 2px 2px "+h+", 0 4px 4px "+h+", 0 8px 8px "+h+", 0 16px 16px "+h+", 0 32px 32px "+f+", 0 64px 64px "+f,t.colors=e,t.rgbaColor=h,t.rgbaColorSecondary=f,t.boxShadow=o}var n=!1,a={hoverTarget:Error("Please provide hoverTarget"),imageTarget:Error("Please provide ImageSrc"),attachBoxShadowTo:null,opacity:.2,opacitySecondary:.2,hoverClass:"box-shadow-attached",colorIndexToUse:0,enterEvent:"mouseenter",leaveEvent:"mouseleave",boxShadowTemplate:""},i={options:{},elements:[],collectElements:function(){var e=i.options.hoverTarget;if("string"==typeof e&&(e=document.querySelectorAll(e)),e.length)for(var t=0;t<e.length;t++){var r=e[t],o=r.querySelector(i.options.imageTarget),n={hoverTarget:r,image:o};i.elements.push(n)}},attachBoxShadowToCollection:function(){i.elements.forEach(function(t){o(e(t.image),t)})},removeBoxShadowFromCollection:function(){i.elements.forEach(function(e){delete e.hoverTarget.dataset.boxShadow})},enterHandler:function(e){return function(t){var r=t.currentTarget.querySelector(i.options.attachBoxShadowTo||i.options.imageTarget);r&&(r.classList.add(i.options.hoverClass),r.style.boxShadow=e.boxShadow)}},leaveHandler:function(e){return function(e){var t=e.currentTarget.querySelector(i.options.attachBoxShadowTo||i.options.imageTarget);t&&(t.classList.remove(i.options.hoverClass),t.style.boxShadow="")}},attachEventListeners:function(){var e=i.options,t=e.enterEvent,r=e.leaveEvent;i.elements.forEach(function(e){e.enterHandler=i.enterHandler(e),e.leaveHandler=i.leaveHandler(e),e.hoverTarget.addEventListener(t,e.enterHandler,!1),e.hoverTarget.addEventListener(r,e.leaveHandler,!1)})},detachEventListeners:function(){var e=i.options,t=e.enterEvent,r=e.leaveEvent;i.elements.forEach(function(e){e.hoverTarget.removeEventListener(t,e.enterHandler,!1),e.hoverTarget.removeEventListener(r,e.leaveHandler,!1)})},init:function(e){if(n)throw new Error("boxShadowPalette is already initialized");return i.options=Object.assign({},a,e),i.collectElements(),i.attachBoxShadowToCollection(),i.attachEventListeners(),n=!0,i},destroy:function(e){void 0===e&&(e=!0),i.detachEventListeners(),e&&i.removeBoxShadowFromCollection(),i.elements=[],n=!1},reInit:function(){i.destroy(),i.init(i.options)},setOptions:function(e,t){void 0===t&&(t=!0),i.options=Object.assign({},i.options,e),t&&i.reInit()},isInitialized:function(){return n}};return i}var t=function(){var e=function(){},t=function(e){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),document.body.appendChild(this.canvas),this.width=this.canvas.width=e.width,this.height=this.canvas.height=e.height,this.context.drawImage(e,0,0,this.width,this.height)};t.prototype.clear=function(){this.context.clearRect(0,0,this.width,this.height)},t.prototype.update=function(e){this.context.putImageData(e,0,0)},t.prototype.getPixelCount=function(){return this.width*this.height},t.prototype.getImageData=function(){return this.context.getImageData(0,0,this.width,this.height)},t.prototype.removeCanvas=function(){this.canvas.parentNode.removeChild(this.canvas)};var r={map:function(e,t){var r={};return t?e.map(function(e,o){return r.index=o,t.call(r,e)}):e.slice()},naturalOrder:function(e,t){return e<t?-1:e>t?1:0},sum:function(e,t){var r={};return e.reduce(t?function(e,o,n){return r.index=n,e+t.call(r,o)}:function(e,t){return e+t},0)},max:function(e,t){return Math.max.apply(null,t?r.map(e,t):e)}},o=function(){function e(e,t,r){return(e<<2*s)+(t<<s)+r}function t(e){function t(){r.sort(e),o=!0}var r=[],o=!1;return{push:function(e){r.push(e),o=!1},peek:function(e){return o||t(),void 0===e&&(e=r.length-1),r[e]},pop:function(){return o||t(),r.pop()},size:function(){return r.length},map:function(e){return r.map(e)},debug:function(){return o||t(),r}}}function o(e,t,r,o,n,a,i){var u=this;u.r1=e,u.r2=t,u.g1=r,u.g2=o,u.b1=n,u.b2=a,u.histo=i}function n(){this.vboxes=new t(function(e,t){return r.naturalOrder(e.vbox.count()*e.vbox.volume(),t.vbox.count()*t.vbox.volume())})}function a(t){var r,o,n,a,i=1<<3*s,u=new Array(i);return t.forEach(function(t){o=t[0]>>h,n=t[1]>>h,a=t[2]>>h,r=e(o,n,a),u[r]=(u[r]||0)+1}),u}function i(e,t){var r,n,a,i=1e6,u=0,c=1e6,s=0,f=1e6,l=0;return e.forEach(function(e){r=e[0]>>h,n=e[1]>>h,a=e[2]>>h,r<i?i=r:r>u&&(u=r),n<c?c=n:n>s&&(s=n),a<f?f=a:a>l&&(l=a)}),new o(i,u,c,s,f,l,t)}function u(t,o){if(o.count()){var n=o.r2-o.r1+1,a=o.g2-o.g1+1,i=o.b2-o.b1+1,u=r.max([n,a,i]);if(1==o.count())return[o.copy()];var c,s,h,f,l,v=0,p=[],g=[];if(u==n)for(c=o.r1;c<=o.r2;c++){for(f=0,s=o.g1;s<=o.g2;s++)for(h=o.b1;h<=o.b2;h++)l=e(c,s,h),f+=t[l]||0;v+=f,p[c]=v}else if(u==a)for(c=o.g1;c<=o.g2;c++){for(f=0,s=o.r1;s<=o.r2;s++)for(h=o.b1;h<=o.b2;h++)l=e(s,c,h),f+=t[l]||0;v+=f,p[c]=v}else for(c=o.b1;c<=o.b2;c++){for(f=0,s=o.r1;s<=o.r2;s++)for(h=o.g1;h<=o.g2;h++)l=e(s,h,c),f+=t[l]||0;v+=f,p[c]=v}return p.forEach(function(e,t){g[t]=v-e}),function(e){var t,r,n,a,i,u=e+"1",s=e+"2",h=0;for(c=o[u];c<=o[s];c++)if(p[c]>v/2){for(n=o.copy(),a=o.copy(),t=c-o[u],r=o[s]-c,i=t<=r?Math.min(o[s]-1,~~(c+r/2)):Math.max(o[u],~~(c-1-t/2));!p[i];)i++;for(h=g[i];!h&&p[i-1];)h=g[--i];return n[s]=i,a[u]=n[s]+1,[n,a]}}(u==n?"r":u==a?"g":"b")}}function c(e,o){function c(e,t){for(var r,o=1,n=0;n<f;)if(r=e.pop(),r.count()){var a=u(s,r),i=a[0],c=a[1];if(!i)return;if(e.push(i),c&&(e.push(c),o++),o>=t)return;if(n++>f)return}else e.push(r),n++}if(!e.length||o<2||o>256)return!1;var s=a(e),h=0;s.forEach(function(){h++});var v=i(e,s),p=new t(function(e,t){return r.naturalOrder(e.count(),t.count())});p.push(v),c(p,l*o);for(var g=new t(function(e,t){return r.naturalOrder(e.count()*e.volume(),t.count()*t.volume())});p.size();)g.push(p.pop());c(g,o-g.size());for(var d=new n;g.size();)d.push(g.pop());return d}var s=5,h=8-s,f=1e3,l=.75;return o.prototype={volume:function(e){var t=this;return t._volume&&!e||(t._volume=(t.r2-t.r1+1)*(t.g2-t.g1+1)*(t.b2-t.b1+1)),t._volume},count:function(t){var r=this,o=r.histo;if(!r._count_set||t){var n,a,i,u,c=0;for(a=r.r1;a<=r.r2;a++)for(i=r.g1;i<=r.g2;i++)for(u=r.b1;u<=r.b2;u++)n=e(a,i,u),c+=o[n]||0;r._count=c,r._count_set=!0}return r._count},copy:function(){var e=this;return new o(e.r1,e.r2,e.g1,e.g2,e.b1,e.b2,e.histo)},avg:function(t){var r=this,o=r.histo;if(!r._avg||t){var n,a,i,u,c,h=0,f=1<<8-s,l=0,v=0,p=0;for(a=r.r1;a<=r.r2;a++)for(i=r.g1;i<=r.g2;i++)for(u=r.b1;u<=r.b2;u++)c=e(a,i,u),n=o[c]||0,h+=n,l+=n*(a+.5)*f,v+=n*(i+.5)*f,p+=n*(u+.5)*f;r._avg=h?[~~(l/h),~~(v/h),~~(p/h)]:[~~(f*(r.r1+r.r2+1)/2),~~(f*(r.g1+r.g2+1)/2),~~(f*(r.b1+r.b2+1)/2)]}return r._avg},contains:function(e){var t=this,r=e[0]>>h,o=e[1]>>h,n=e[2]>>h;return r>=t.r1&&r<=t.r2&&o>=t.g1&&o<=t.g2&&n>=t.b1&&n<=t.b2}},n.prototype={push:function(e){this.vboxes.push({vbox:e,color:e.avg()})},palette:function(){return this.vboxes.map(function(e){return e.color})},size:function(){return this.vboxes.size()},map:function(e){for(var t=this.vboxes,r=0;r<t.size();r++)if(t.peek(r).vbox.contains(e))return t.peek(r).color;return this.nearest(e)},nearest:function(e){for(var t,r,o,n=this.vboxes,a=0;a<n.size();a++)((r=Math.sqrt(Math.pow(e[0]-n.peek(a).color[0],2)+Math.pow(e[1]-n.peek(a).color[1],2)+Math.pow(e[2]-n.peek(a).color[2],2)))<t||void 0===t)&&(t=r,o=n.peek(a).color);return o},forcebw:function(){var e=this.vboxes;e.sort(function(e,t){return r.naturalOrder(r.sum(e.color),r.sum(t.color))});var t=e[0].color;t[0]<5&&t[1]<5&&t[2]<5&&(e[0].color=[0,0,0]);var o=e.length-1,n=e[o].color;n[0]>251&&n[1]>251&&n[2]>251&&(e[o].color=[255,255,255])}},{quantize:c}}();return e.prototype.getColor=function(e,t){return this.getPalette(e,5,t)[0]},e.prototype.getPalette=function(e,r,n){(void 0===r||r<2||r>256)&&(r=10),(void 0===n||n<1)&&(n=10);for(var a,i,u,c,s=new t(e),h=s.getImageData(),f=h.data,l=s.getPixelCount(),v=[],p=0;p<l;p+=n)a=4*p,i=f[a+0],u=f[a+1],c=f[a+2],f[a+3]>=125&&(i>250&&u>250&&c>250||v.push([i,u,c]));var g=o.quantize(v,r),d=g?g.palette():null;return s.removeCanvas(),d},e.prototype.getColorFromUrl=function(e,t,r){sourceImage=document.createElement("img");var o=this;sourceImage.addEventListener("load",function(){t(o.getPalette(sourceImage,5,r)[0],e)}),sourceImage.src=e},e.prototype.getImageData=function(e,t){xhr=new XMLHttpRequest,xhr.open("GET",e,!0),xhr.responseType="arraybuffer",xhr.onload=function(e){if(200==this.status){uInt8Array=new Uint8Array(this.response),r=uInt8Array.length,binaryString=new Array(r);for(var r=0;r<uInt8Array.length;r++)binaryString[r]=String.fromCharCode(uInt8Array[r]);data=binaryString.join(""),base64=window.btoa(data),t("data:image/png;base64,"+base64)}},xhr.send()},e.prototype.getColorAsync=function(e,t,r){var o=this;this.getImageData(e,function(e){sourceImage=document.createElement("img"),sourceImage.addEventListener("load",function(){t(o.getPalette(sourceImage,5,r)[0],this)}),sourceImage.src=e})},e}();return e});